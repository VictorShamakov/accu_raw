---
title: "AST"
output: html_document
date: "2024-06-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  include = TRUE,
  message= FALSE, 
  warning= FALSE
)
```

```{r include=F}
rm(list=ls())
source("./ast_functions.R")
library("readxl")
library("gridExtra")
ideal_coords <- read.csv2("./data/IdealCoords.csv", stringsAsFactors = F, col.names = c("x_mouse_pos","y_mouse_pos"), header = F)
options(scipen = 10)
```

```{r}
test_id <- 66 # ID экземпляра теста в Moodle LMS
tracker_id <- 1 # ID tracker для сервиса mouse tracking
```

```{r}
validated_results <- read_xlsx("../Accu/results/features_ast_prepaired.xlsx") # Валидные данные  теста
validated_results$test_id <- test_id

# accu_data <- read.csv("./data/raw/accu.csv") # Результаты эксперимента компромисс скорость-точность
accu_data <- readRDS("./data/raw/2024-10-21 - accu.rds") # Результаты эксперимента компромисс скорость-точность
accu_data <- merge(accu_data, select(validated_results, user_id, test_id), by = c("user_id", "test_id"), all.y = F)

# users <- read.csv("./data/raw/users.csv") # Пользователи прошедшие тестирование
users <- readRDS("./data/raw/2024-10-21 - users.rds")
users <- merge(users, select(accu_data, user_id), by = "user_id")

# sessions <- read.csv("./data/raw/sessions.csv") # Сессии mouse tracker'a
sessions <- readRDS("./data/raw/2024-10-21 - sessions.rds") # Сессии mouse tracker'a
sessions <- merge(sessions, select(users, user_id), by = "user_id")

# event_tracks <- read.csv("./data/raw/event_tracks.csv") # Треки событий 
event_tracks <- readRDS("./data/raw/2024-10-21 - event_tracks.rds") # Треки событий 
event_tracks <- merge(event_tracks, select(sessions, session_id), by = "session_id")

# mouse_tracks <- read.csv("./data/raw/mouse_tracks.csv") # Треки мыши
mouse_tracks <- readRDS("./data/raw/2024-10-21 - mouse_tracks.rds") # Треки мыши
mouse_tracks <- merge(mouse_tracks, select(sessions, session_id), by = "session_id")

```

```{r}
for (user_id in validated_results$user_id) {
  print(user_id)
  ast <- accu_data[accu_data$user_id == user_id & accu_data$test_id == test_id,]
  ast$tracker_id <- tracker_id
  ast_data <- form_ast_data(ast$data)

  ast <- get_session_from_file(ast, ast_data, sessions, event_tracks)

  accuracy_ast_data <- ast_data[, 1:(ncol(ast_data) / 2)] # выбираем часть эксперимента на точность
  accuracy_datasets <- get_all_datasets(ast=ast, ast_data=accuracy_ast_data, mouse_tracks = mouse_tracks, ideal_coords = ideal_coords)

  speed_ast_data <- ast_data[, ((ncol(ast_data) / 2) + 1):ncol(ast_data)]
  speed_datasets <- get_all_datasets(ast=ast, ast_data=speed_ast_data, mouse_tracks=mouse_tracks, ideal_coords = ideal_coords)
  
  ## Обработка всех данных
  if (!file.exists(file.path("./data/alphabet/", user_id))){
    dir.create(file.path("./data/alphabet/", user_id))
  }
  
  accuracy_datasets$ast_long$stage <- "accuracy"
  speed_datasets$ast_long$stage <- "speed"
  accuracy_datasets$ast_mt$stage <- "accuracy"
  speed_datasets$ast_mt$stage <- "speed"
  accuracy_datasets$ast_merged$stage <- "accuracy"
  speed_datasets$ast_merged$stage <- "speed"
  
  ast_long <- rbind(accuracy_datasets$ast_long, speed_datasets$ast_long)
  ast_mt <- rbind(accuracy_datasets$ast_mt, speed_datasets$ast_mt)
  ast_merged <- rbind(accuracy_datasets$ast_merged, speed_datasets$ast_merged)
  
  saveRDS(ast_long, file = paste0("./data/alphabet/" %+% user_id %+% "/ast_results.rds"))
  
  ## Разделение на алфавит
  # ast_merged$target_numbers <- get_target_numbers(ast_merged$event_type, "click")
  
  
  # for (n in unique(ast_merged$target_numbers)) {
  #   slice <- ast_merged[ast_merged$target_numbers == n, ]
  #   saveRDS(slice, file = paste0("./data/alphabet/" %+% user_id %+% "/" %+% n %+% ".rds"))
  #   
  #   # p <- ggplot(data = slice) +
  #   #   geom_line(aes(x_mouse_pos, y_mouse_pos)) +
  #   #   geom_point(data = ast_long[n,], aes(x_mouse_pos, y_mouse_pos), shape=21, size=11, alpha=0.8, fill="white") +
  #   #   scale_y_reverse(limits=c(ast$canvas_height + ast$canvas_coords_y, ast$canvas_coords_y)) +
  #   #   xlim(ast$canvas_coords_x, ast$canvas_coords_x + ast$canvas_width)
  #   # 
  #   # print(p)
  # }
}



```


